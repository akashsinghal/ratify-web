# Vulnerability Report

This document outlines how Ratify can be used to verifier vulernability reports. The `vulnerabilityreport` verifier is added as a plugin to the ratify verification framework. Currently the vulnerability report verifier supports the following report types:

- Reports attached to the subject image as a referrer artifact
- Reports in SARIF format
- Reports generated by [Trivy](https://aquasecurity.github.io/trivy/v0.47/) or [Grype](https://github.com/anchore/grype)

## Table of Contents

* [Example Scenario](#example-scenario)
* [Configuration](#configuration)
* [Advanced](#advanced-scenario-vulnerability-report-validation--integrity)

## Example Scenario 

Alice has a Kubernetes cluster. She installs Ratify with Gatekeeper on her cluster using the Ratify Quickstart guide. She now wants to enable vulnerability report verification. In particular, she wants to make sure all container images used in K8s resources hava vulnerability report attached to the image. The report must:
- be in SARIF format
- generated from Trivy or Grype
- created less than 24 hours ago
- has no HIGH or CRITICAL severity level vulnerabilities in the report
- does not contain the log4shell CVE 

An image `myregistry.io/vuln/alpine:3.18.2` is scanned and a vulnerability report is generated. A reference artifact is generated:
1. Use Trivy to scan `myregistry.io/vuln/alpine:3.18.2` and output a report in SARIF format
    ```shell
    trivy image -q -f sarif myregistry.io/vuln/alpine:3.18.2 > trivy-sarif.json
    ```
2. A tool such as `oras` is used to package, attach, and then push the report to registry
    - `artifact-type` MUST be `application/sarif+json`
    - file media type (layer) MUST be `application/sarif+json`
    - `org.opencontainers.image.created` annotation with RFC3339 formatted current timestamp
    ```shell
    oras attach \
        --artifact-type application/sarif+json \
        --annotation "org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
        myregistry.io/vuln/alpine:3.18.2 \
        trivy-sarif.json:application/sarif+json
    ```
The resulting image will have a single SARIF vulnerability report artifact attached:

```shell
> oras discover myregistry.io/vuln/alpine:3.18.2 -o tree
myregistry.io/vuln/alpine@sha256:25fad2a32ad1f6f510e528448ae1ec69a28ef81916a004d3629874104f8a7f70
└── application/sarif+json
    └── sha256:6170ef41e5a7c7088f86e3bc6b9c370cf97e613f7c7e359628c0119ec7d3d5f4
```
Next, we configure Ratify with a `vulnerabilityreport` verifier Custom Resource:
```yaml
apiVersion: config.ratify.deislabs.io/v1beta1
kind: Verifier
metadata:
  name: verifier-vulnerabilityreport
spec:
  name: vulnerabilityreport
  artifactTypes: application/sarif+json
  parameters:
    maximumAge: 24h
    disallowedSeverity:
      - high
      - critical
    denylistCVEs:
      - CVE-2021-44228 # Log4Shell
```

Finally we will attempt to deploy our test image `myregistry.io/vuln/alpine:3.18.2`. We expect this to FAIL since our vulnerability report indicates multiple HIGH and CRITICAL level severities:

```shell
> kubectl run vuln-alpine-image -n default --image=myregistry.io/vuln/alpine:3.18.2
Error from server (Forbidden): admission webhook "validation.gatekeeper.sh" denied the request: [vulnerability-report-validation-constraint] Subject failed verification: myregistry.io/vuln/alpine@sha256:25fad2a32ad1f6f510e528448ae1ec69a28ef81916a004d3629874104f8a7f70
```

Taking a look at the Ratify logs reveals the failing report:

```json
> kubectl logs deploy/ratify -n gatekeeper-system
time=2023-11-20T12:00:00Z level=info msg=verify result for subject myregistry.io/vuln/alpine@sha256:25fad2a32ad1f6f510e528448ae1ec69a28ef81916a004d3629874104f8a7f70: {
  "verifierReports": [
    {
      "subject": "artifactstest.azurecr.io/vuln-demo/alpine@sha256:25fad2a32ad1f6f510e528448ae1ec69a28ef81916a004d3629874104f8a7f70",
      "isSuccess": false,
      "name": "vulnerabilityreport",
      "message": "vulnerability report validation failed",
      "extensions": {
        "scanner": "trivy",
        "severityViolations": [
          {
            "defaultConfiguration": {
              "level": "error"
            },
            "fullDescription": {
              "text": "There is a stack overflow vulnerability in ash.c:6030 in busybox before 1.35. In the environment of Internet of Vehicles, this vulnerability can be executed from command to arbitrary code execution."
            },
            "help": {
              "markdown": "**Vulnerability CVE-2022-48174**\n| Severity | Package | Fixed Version | Link |\n| --- | --- | --- | --- |\n|CRITICAL|ssl_client|1.36.1-r1|[CVE-2022-48174](https://avd.aquasec.com/nvd/cve-2022-48174)|\n\nThere is a stack overflow vulnerability in ash.c:6030 in busybox before 1.35. In the environment of Internet of Vehicles, this vulnerability can be executed from command to arbitrary code execution.",
              "text": "Vulnerability CVE-2022-48174\nSeverity: CRITICAL\nPackage: ssl_client\nFixed Version: 1.36.1-r1\nLink: [CVE-2022-48174](https://avd.aquasec.com/nvd/cve-2022-48174)\nThere is a stack overflow vulnerability in ash.c:6030 in busybox before 1.35. In the environment of Internet of Vehicles, this vulnerability can be executed from command to arbitrary code execution."
            },
            "helpUri": "https://avd.aquasec.com/nvd/cve-2022-48174",
            "id": "CVE-2022-48174",
            "name": "OsPackageVulnerability",
            "properties": {
              "precision": "very-high",
              "security-severity": "9.8",
              "tags": [
                "vulnerability",
                "security",
                "CRITICAL"
              ]
            },
            "shortDescription": {
              "text": "stack overflow vulnerability in ash.c leads to arbitrary code execution"
            }
          },
          ...
        ]
      }
    }
  ]
}

```
## Configuration

### Kubernetes

Sample YAML
```json
apiVersion: config.ratify.deislabs.io/v1beta1
kind: Verifier
metadata:
  name: verifier-vulnerabilityreport
spec:
  name: vulnerabilityreport
  artifactTypes: application/sarif+json
  parameters:
    maximumAge: 24h
    disallowedSeverity:
      - high
      - critical
    denylistCVEs:
      - CVE-2021-44228 # Log4Shell
```

| Name               | Required | Path                               | Description                                                                                            | Default Value |
| ------------------ | -------- | ---------------------------------- | ------------------------------------------------------------------------------------------------------ | ------------- |
| maximumAge         | No       | spec.parameters.maximumAge         | The string formatted max age of report                                                                 | ""            |
| disallowedSeverity | No       | spec.parameters.disallowedSeverity | String array of disallowed severities. Verification fails if ANY specified severity found              | []            |
| denylistCVEs       | No       | spec.parameters.denylistCVEs       | String array of CVE IDs. Verification fails if ANY specified CVE ID found                              | []            |
| passthrough        | No       | spec.parameters.passthrough        | Bypasses all verification except for `maximumAge`. Report content in `report` field of verifier report | false |

### CLI

Sample JSON
```json
{
    "store": {
        "version": "1.0.0",
        "plugins": [
            {
                "name": "oras",
            }
        ]
    },
    "policy": {
        "version": "1.0.0",
        "plugin": {
            "name": "configPolicy"
        }
    },
    "verifier": {
        "version": "1.0.0",
        "plugins": [
            {
                "name": "vulnerabilityreport",
                "artifactTypes": "application/sarif+json",
                "maximumAge": "24h",
                "disallowedSeverity": ["high", "critical"],
                "denylistCVEs": ["CVE-2021-44228"]
            }
        ]
    }
}
```

## Advanced Scenario: vulnerability report validation + integrity


